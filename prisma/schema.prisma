// Prisma schema for Slack Question Router

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workspace {
  id           String   @id @default(uuid())
  slackTeamId  String   @unique @map("slack_team_id")
  teamName     String?  @map("team_name")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  channels          Channel[]
  users             User[]
  questions         Question[]
  config            WorkspaceConfig?
  dailyStats        DailyStat[]
  escalationTargets EscalationTarget[]

  @@map("workspaces")
}

model Channel {
  id              String   @id @default(uuid())
  workspaceId     String   @map("workspace_id")
  slackChannelId  String   @map("slack_channel_id")
  channelName     String?  @map("channel_name")
  isMonitored     Boolean  @default(true) @map("is_monitored")
  settings        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  workspace       Workspace  @relation(fields: [workspaceId], references: [id])
  questions       Question[]
  dailyStats      DailyStat[]

  @@unique([workspaceId, slackChannelId])
  @@map("channels")
}

model User {
  id            String    @id @default(uuid())
  workspaceId   String    @map("workspace_id")
  slackUserId   String    @map("slack_user_id")
  displayName   String?   @map("display_name")
  realName      String?   @map("real_name")
  isActive      Boolean   @default(true) @map("is_active")
  lastSeenAt    DateTime? @map("last_seen_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  workspace           Workspace         @relation(fields: [workspaceId], references: [id])
  questionsAsked      Question[]        @relation("QuestionAsker")
  questionsAnswered   Question[]        @relation("QuestionAnswerer")
  expertise           UserExpertise[]
  finalEscalationFor  WorkspaceConfig[]

  @@unique([workspaceId, slackUserId])
  @@index([isActive, lastSeenAt])
  @@map("users")
}

model Question {
  id                String    @id @default(uuid())
  workspaceId       String    @map("workspace_id")
  channelId         String    @map("channel_id")
  askerId           String    @map("asker_id")
  slackMessageId    String    @map("slack_message_id")
  slackThreadId     String?   @map("slack_thread_id")
  messageText       String    @map("message_text") @db.Text
  extractedKeywords String[]  @map("extracted_keywords")
  askedAt           DateTime  @map("asked_at")
  answeredAt        DateTime? @map("answered_at")
  answererId        String?   @map("answerer_id")
  answerSlackMessageId String? @map("answer_slack_message_id")
  status            String    @default("unanswered")
  escalationLevel   Int       @default(0) @map("escalation_level")
  lastEscalatedAt   DateTime? @map("last_escalated_at")
  isSideConversation Boolean  @default(false) @map("is_side_conversation")
  zendeskTicketId   String?   @map("zendesk_ticket_id")
  sourceApp         String    @default("slack") @map("source_app")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  workspace         Workspace          @relation(fields: [workspaceId], references: [id])
  channel           Channel            @relation(fields: [channelId], references: [id])
  asker             User               @relation("QuestionAsker", fields: [askerId], references: [id])
  answerer          User?              @relation("QuestionAnswerer", fields: [answererId], references: [id])
  escalations       Escalation[]
  escalationEvents  EscalationEvent[]

  @@unique([workspaceId, slackMessageId])
  @@index([status, askedAt])
  @@index([status, escalationLevel])
  @@index([channelId, askedAt])
  @@index([isSideConversation, status, askedAt])
  @@map("questions")
}

model UserExpertise {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  topic           String
  confidenceScore Float     @default(0.5) @map("confidence_score")
  answerCount     Int       @default(0) @map("answer_count")
  lastAnsweredAt  DateTime? @map("last_answered_at")
  source          String    @default("auto")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, topic])
  @@index([topic, confidenceScore])
  @@map("user_expertise")
}

model Escalation {
  id              String   @id @default(uuid())
  questionId      String   @map("question_id")
  escalationLevel Int      @map("escalation_level")
  suggestedUsers  String[] @map("suggested_users")
  actionTaken     String?  @map("action_taken")
  escalatedAt     DateTime @default(now()) @map("escalated_at")

  question Question          @relation(fields: [questionId], references: [id])
  events   EscalationEvent[]

  @@map("escalations")
}

model EscalationEvent {
  id              String   @id @default(uuid())
  questionId      String   @map("question_id")
  escalationId    String   @map("escalation_id")
  targetType      String   @map("target_type")     // 'user', 'user_group', 'channel'
  targetId        String   @map("target_id")
  targetName      String?  @map("target_name")
  status          String   @default("pending")     // 'success', 'failed', 'skipped'
  errorMessage    String?  @map("error_message") @db.Text
  notifiedAt      DateTime @default(now()) @map("notified_at")

  question   Question   @relation(fields: [questionId], references: [id])
  escalation Escalation @relation(fields: [escalationId], references: [id])

  @@index([questionId])
  @@index([escalationId])
  @@index([questionId, status])
  @@map("escalation_events")
}

model WorkspaceConfig {
  id                        String   @id @default(uuid())
  workspaceId               String   @unique @map("workspace_id")
  answerDetectionMode       String   @default("emoji_only") @map("answer_detection_mode")
  firstEscalationMinutes    Int      @default(120) @map("first_escalation_minutes")
  secondEscalationMinutes   Int      @default(240) @map("second_escalation_minutes")
  finalEscalationMinutes    Int      @default(1440) @map("final_escalation_minutes")
  gracePeriodMinutes        Int      @default(30) @map("grace_period_minutes")
  dmSuggestionsEnabled      Boolean  @default(true) @map("dm_suggestions_enabled")
  threadPostsEnabled        Boolean  @default(true) @map("thread_posts_enabled")
  finalEscalationUserId     String?  @map("final_escalation_user_id")
  escalationUserGroup       String?  @map("escalation_user_group")
  escalationChannelId       String?  @map("escalation_channel_id")
  migratedToTargets         Boolean  @default(false) @map("migrated_to_targets")
  settings                  Json?
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  workspace             Workspace @relation(fields: [workspaceId], references: [id])
  finalEscalationUser   User?     @relation(fields: [finalEscalationUserId], references: [id])

  @@map("workspace_config")
}

model DailyStat {
  id                     String   @id @default(uuid())
  workspaceId            String   @map("workspace_id")
  channelId              String?  @map("channel_id")
  date                   DateTime @db.Date
  questionsAsked         Int      @default(0) @map("questions_asked")
  questionsAnswered      Int      @default(0) @map("questions_answered")
  avgResponseTimeMinutes Int?     @map("avg_response_time_minutes")
  createdAt              DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  channel   Channel?  @relation(fields: [channelId], references: [id])

  @@unique([workspaceId, channelId, date])
  @@map("daily_stats")
}

model EscalationTarget {
  id              String   @id @default(uuid())
  workspaceId     String   @map("workspace_id")
  targetType      String   @map("target_type")     // 'user', 'user_group', 'channel'
  targetId        String   @map("target_id")       // Slack ID (user ID, group ID, or channel ID)
  targetName      String?  @map("target_name")     // Display name for UI
  escalationLevel Int      @map("escalation_level") // Which escalation level (1, 2, 3, etc.)
  priority        Int      @default(0)              // Order within the same level (lower = higher priority)
  isActive        Boolean  @default(true) @map("is_active")
  settings        Json?                             // Additional settings (e.g., notification preferences)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, targetType, targetId, escalationLevel])
  @@index([workspaceId, escalationLevel, priority])
  @@map("escalation_targets")
}

model SlackInstallation {
  id           String   @id @default(uuid())
  teamId       String?  @unique @map("team_id")
  enterpriseId String?  @unique @map("enterprise_id")
  botToken     String   @map("bot_token") @db.Text
  botUserId    String   @map("bot_user_id")
  botScopes    String[] @map("bot_scopes")
  userToken    String?  @map("user_token") @db.Text
  userId       String?  @map("user_id")
  userScopes   String[] @map("user_scopes")
  incomingWebhook Json?  @map("incoming_webhook")
  appId        String   @map("app_id")
  tokenType    String   @default("bot") @map("token_type")
  isEnterpriseInstall Boolean @default(false) @map("is_enterprise_install")
  metadata     Json?    // Full installation data backup
  installedAt  DateTime @default(now()) @map("installed_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([teamId])
  @@index([enterpriseId])
  @@map("slack_installations")
}
